<?php
/**
 * @file
 * Code for eMindHub Profile Complete feature.
 */

/**
 * Implements hook_preprocess_status_messages().
 */
function emh_profile_complete_preprocess_status_messages(&$variables) {
  if (module_exists('user_registrationpassword')) {
    // https://api.drupal.org/comment/51793#comment-51793
    $message = 'You have just used your one-time login link. Your account is now active and you are authenticated.';
    if (isset($_SESSION['messages'])) {
      foreach ($_SESSION['messages'] as $type => $messages) {
        if ($type == 'status') {
          $pos = array_search($message, $messages);
          if ($pos !== FALSE) {
            unset($_SESSION['messages'][$type][$pos]);
            // http://dropbucket.org/node/547
            // Remove the empty status message wrapper if no other messages have been set.
            if (empty($_SESSION['messages'][$type])) {
              unset($_SESSION['messages'][$type]);
            }
          }
        }
      }
    }
  }
}

function emh_profile_complete_get_required_expert_fields() {
  $required_fields = array(
    'field_entreprise',
    'field_working_status',
    'field_domaine',
  );
  return $required_fields;
}

function emh_profile_complete_get_required_empty_profile_form($form, &$form_state) {

  global $user;
  $account = user_load($user->uid);
  $attach_form = array();

  // TODO
  // $required_fields = emh_profile_complete_get_required_empty_fields();
  $required_fields = emh_profile_complete_get_required_expert_fields();

  foreach ($required_fields as $required_field) {
    if (field_access('edit', $required_field, 'user')) {
      field_attach_form('user', $account, $attach_form, $form_state, NULL, array('field_name' => $required_field));
      $form[$required_field] = $attach_form[$required_field];
    }
  }

  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Update your profile'),
    '#weight' => '100',
  );

  return $form;

}

function emh_profile_complete_get_required_empty_profile_form_submit($form, &$form_state) {

  global $user;
  $account = user_load($user->uid);
  $edit = array();

  // TODO
  // $required_fields = emh_profile_complete_get_required_missing_fields();
  $required_fields = emh_profile_complete_get_required_expert_fields();

  foreach ($required_fields as $required_field) {
    $field_name = $required_field;
    $edit[$field_name] = $form_state['values'][$field_name];
  }

  $edit = array_merge( $edit, array(
    'status' => 1,
    'access' => REQUEST_TIME,
  ) );

  drupal_set_message(t('Your profile has been updated. You have now access to client requests.'));

  user_save($account, $edit);

}

// function emh_profile_complete_get_required_empty_fields() {
//   module_load_include('pages.inc', 'user', 'user');
//   global $user;
//   $account = user_load($user->uid);
//   $form = drupal_get_form('user_profile_form', $user);
//   return _find_all_children_required_empty_elements($form, 'user', $account);
// }

// function _find_all_children_required_empty_elements(&$element, $entity_type = NULL, $entity = NULL) {
//   $results = array();
//   $children = element_children($element);
//   $entityID = entity_extract_ids($entity_type, $entity);
//
//   foreach ($children as $key) {
//     $child = &$element[$key];
//     if (is_array($child)) {
//         $field_name = $child['#field_name'];
//         if ( field_access('edit', $child, 'user') && !empty($child['#type']) && !empty($child['#required']) && ($field_name !== 'field_first_name') || ($field_name !== 'field_last_name') || ($field_name !== 'field_needs_for_expertise') && !(field_get_items($entity, $entityID[0], $child)) )
//           $results[] = &$child;
//
//         $results = array_merge($results, _find_all_children_required_empty_elements($child));
//     }
//     unset($child);
//   }
//   return $results;
// }


/**
 * Implements hook_user_login().
 */
function emh_profile_complete_user_login(&$edit, $account) {
  $user_roles = array(
    '0' => '4', // Expert
    '1' => '5', // Business
  );
  $user_messages = array(
    '4' => t('<strong>Promote your expertise</strong> by <a href="[current-user:edit-url]">filling out your profile</a>.'), // Expert
    '5' => t('To better <strong>meet your expectations</strong>, please <a href="[current-user:edit-url]">fill out your profile</a>.'), // Business
  );
  $current_user_roles = array_keys($account->roles);
  $check_user_role = array_intersect($current_user_roles, $user_roles);
  if (!empty($check_user_role)) {
    $emh_profile_complete_data = pcp_get_complete_percentage_data('user', 'user', $account);
    if ($emh_profile_complete_data['current_percent'] < 100) {
      $current_user_object['user'] = $account;
      foreach ($check_user_role as $role) {
        $emh_profile_complete_login_message = token_replace($user_messages[$role], $current_user_object);
        drupal_set_message($emh_profile_complete_login_message, 'warning');
      }
    }
  }
}
