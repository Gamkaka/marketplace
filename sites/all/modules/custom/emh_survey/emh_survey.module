<?php
/**
* @file
* Code for eMindHub survey feature.
*/


function emh_survey_form_alter(&$form, &$form_state, $form_id) {

	if ((isset($form['#node']) && $form['#node']->type == 'webform')) {
		$form['actions']['submit']['#value'] = t('Submit my answer');

		// echo '<pre>' . print_r($form, TRUE) . '</pre>';
	  // echo '<pre>' . print_r(element_children($form), TRUE) . '</pre>';
    if (isBusinessUser()) {
      foreach($form['submitted'] as $key => $element) {
        if (is_array($element) && !empty($element['#type']) && $element['#type'] == 'textarea') {
          $form['submitted'][$key]['#disabled'] = 'disabled';
          $form['actions']['#access'] = FALSE;
        }
      }
    }
  }

}


/* Webform hook form alter
 * node/add/webform
 * node/$ID/edit
 */
function emh_survey_form_webform_node_form_alter(&$form, &$form_state, $form_id) {

	// echo '<pre>' . print_r($form, TRUE) . '</pre>';
	// echo '<pre>' . print_r($form_state, TRUE) . '</pre>';

	// Add class before & after fields
  $form['field_duration_of_the_mission']['#prefix'] = '<div class="form-group-2col row">';
  $form['field_start_date']['#suffix'] = '</div>';

  $form['field_document']['#prefix'] = '<div class="form-group-2col row">';
  $form['field_image']['#suffix'] = '</div>';

  $form['field_domaine']['#prefix'] = '<div class="form-group-2col row">';
  $form['field_tags']['#suffix'] = '</div>';

  $form['field_anonymous']['#prefix'] = '<div class="form-group-3col row">';
  $form['field_use_my_entreprise']['#suffix'] = '</div>';

  $form['field_expiration_date']['#prefix'] = '<div class="form-group-2col row">';
	$form['field_reward']['und'][0]['value']['#title'] = t('Cost (minimum 1 000 points required)');
  $form['field_reward']['#suffix'] = '</div>';

	$form['field_document']['und'][0]['#process'][] = 'emindhub_my_file_element_process';
  $form['field_image']['und'][0]['#process'][] = 'emindhub_my_file_element_process';

	$form['actions']['submit']['#value'] = t('Save and continue');

	$form['group_content_access']['#access'] =  FALSE;
}


/* Webform hook form alter
 * node/$ID/webform
 * node/$ID/webform/components
 */
function emh_survey_form_webform_components_form_alter(&$form, &$form_state, $form_id) {

	// echo '<pre>' . print_r($form, TRUE) . '</pre>';
	// echo '<pre>' . print_r($form_state, TRUE) . '</pre>';

	// Hide unnecessary fields
	foreach (
		array(
			'type',
			'required',
		) as $field) {
		$form['add'][$field]['#type'] = 'hidden';
	}

	$form['add']['type']['#default_value'] = 'textarea';

	$form['actions']['submit']['#value'] = t('Save order of questions');

	$webform_id = $form['#node']->nid;
	$form['actions']['goback']['#markup'] = t('<a href="@url" class="btn btn-default" id="edit-back">Back</a>', array('@url' => url('node/' . $webform_id . '/edit')));
	$form['actions']['goback']['#access'] = TRUE;

	$form['actions']['see']['#markup'] = t('<a href="@url" class="btn-submit btn btn-primary form-submit" id="edit-view">Publish your survey</a>', array('@url' => url('node/' . $webform_id)));
	$form['actions']['see']['#access'] = TRUE;

  $form['#submit'][] = 'emh_survey_remove_param';
}

/**
 * Helper submit callback that removes cid parameter.
 */
function emh_survey_remove_param($form, &$form_state) {
  $nid = $form_state['values']['nid'];
  $form_state['redirect'] = 'node/' . $nid . '/webform/components';
}


/* Webform hook form alter
 * node/$ID/webform/components/$ID
 */
function emh_survey_form_webform_component_edit_form_alter(&$form, &$form_state, $form_id) {

	// echo '<pre>' . print_r($form, TRUE) . '</pre>';
	// echo '<pre>' . print_r($form_state, TRUE) . '</pre>';

	// Question label
	$form['name']['#title'] = t('Your question');

	// Hide unnecessary fields
	foreach (
		array(
			'form_key',
			'value',
			'display',
			'validation',
			'position',
		) as $field) {
		$form[$field]['#access'] = FALSE;
	}

	// Hide unnecessary field description
	$form['name']['#description'] = '';
	$form['extra']['description']['#title'] = t('Description (additional information to clarify the meaning of your question)');
	$form['extra']['description']['#description'] = '';

	// Change description format (textarea is too big)
	$form['extra']['description']['#type'] = 'textfield';

	// We hide mandatory field BUT we don't forget to force it
	$form['validation']['required']['#default_value'] = 1;

	// Action submit label
	$form['actions']['submit']['#value'] = t('Save your question');

	// echo '<pre>' . print_r($form, TRUE) . '</pre>';
}

/**
 * Implements hook_node_defaults_alter().
 */
function emh_survey_webform_node_defaults_alter(&$defaults) {
  $defaults['enforce_limit'] = 'yes';
  $defaults['submit_limit'] = '1';
  $defaults['submit_interval'] = '-1';
  $defaults['submit_notice'] = '0';
}
