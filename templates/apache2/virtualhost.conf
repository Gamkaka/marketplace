__SSL_REDIRECT__
<VirtualHost *:__PORT__>

    ServerName __DOMAIN__

    __SSL_PART__

     ErrorLog ${APACHE_LOG_DIR}/__DOMAIN__.error.log
     CustomLog ${APACHE_LOG_DIR}/__DOMAIN__.access.log combined

    <Directory  /  >
        # version 2.4
        #Require all denied
        # version 2.2
        Order deny,allow
        deny from all

        Options FollowSymLinks
        # PREVENT .htaccess reading #! <------------------- WARNING, this disable ALL .htaccess files
        AllowOverride None

        #.svn & .git directories must be avoided!!
        RedirectMatch 404 /.svn(/|$)
        RedirectMatch 404 /.git(/|$)
    </Directory>

    DocumentRoot /var/www/__DOMAIN__/www

    <Directory /var/www/__DOMAIN__/www>

        __INCLUDE_AUTH__

        # version 2.4
        #Require all granted
        # version 2.2
        Order allow,deny
        Allow from all

        Options +FollowSymLinks -Indexes -Multiviews

        DirectoryIndex index.php

        <FilesMatch "\.(yml|engine|inc|info|install|make|module|profile|test|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)(~|\.sw[op]|\.bak|\.orig|\.save)?$|^(\..*|Entries.*|Repository|Root|Tag|Template)$|^#.*#$|\.php(~|\.sw[op]|\.bak|\.orig\.save)$">
              Order allow,deny
        </FilesMatch>
        # Force simple error message for requests for non-existent favicon.ico.
        <Files favicon.ico>
            # There is no end quote below, for compatibility with Apache 1.3.
            ErrorDocument 404 "The requested file favicon.ico was not found.
        </Files>

        # Make Drupal handle any 404 errors.
        ErrorDocument 404 /index.php

        # Requires mod_expires to be enabled.
        <IfModule mod_expires.c>
            # Enable expirations.
            ExpiresActive On
            # Cache all files for 2 weeks after access (A).
            ExpiresDefault A1209600
            <FilesMatch \.php$>
               # Do not allow PHP scripts to be cached unless they explicitly send cache
               # headers themselves. Otherwise all scripts would have to overwrite the
               # headers set by mod_expires if they want another caching behavior. This may
               # fail if an error occurs early in the bootstrap process, and it may cause
               # problems if a non-Drupal PHP file is installed in a subdirectory.
               ExpiresActive Off
           </FilesMatch>
      </IfModule>


    # Various rewrite rules.
    <IfModule mod_rewrite.c>
        RewriteEngine on


        ######### START RULE 1 ##################################
        # clean url is activated so ALL urls
        # MUST be accessed on /too/titi and MUSN'T be accessed on index.php?q=/toto/titi
        # main reason is that applying url rules (like restricting /admin access is far easier
        # in the clean url form than in parameter form
        # WARNING: need to alter any 'q' parameter that could be present
        # on original QUERY_STRING (part after the ?), or something
        # like /toto?q=admin could become a q=toto&q=admin
        # which is finally a q=admin, so we do not restrict
        # this rule to index.php
        #########################################################
        # WARNING: must prevent real internal redirect of :
        # /toto/titi to q=/toto/titi (done in rule 2)
        # to be forbidden, so the rule apply only
        # if the rewriting process is starting
        RewriteCond %{ENV:REDIRECT_STATUS} ^$

        # detect non-blank QUERY_STRING (some parameters are present after the ?)
        # else we have nothing to fear about blank queries
        RewriteCond %{QUERY_STRING} . [NC]

        # we prevent any query with a q= parameter
        RewriteCond %{QUERY_STRING} (^|&|%26|%20)(q|Q|%71|%51)(=|%3D). [NC]

        # 403 FORBIDDEN !
        RewriteRule .* - [F,L]
        ########## END RULE 1 ###################

        ########## START RULE 2 ###################
        # Clean url handling
        # for things which aren't real files or dir then
        # take the given url and giv it to index.php?q=...
        ###########################################
        # all url that didn't match ALL previous rewriteCond are still there
        # squeeze real files or directories, if they really exists 
        # then Drupal won't be called
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d

        # do not handle the favicon with Drupal bootstrap
        # comment if you want it
        RewriteCond %{REQUEST_URI} !=/favicon.ico

        # put everything still there to Drupal index.php
        # [L]= stop rewriting here for matching rules
        # [QSA]=Appends any query string created in the rewrite target 
        # to any query string that was in the original request URL
        RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
        ########## END RULE 2 ###################


        ########## START RULE 3 ###################
        # deny direct access to php files which aren't
        # index.php or update.php or install.php or xmlrpc.php or cron.php
        # (like an injected phpinfo.php)
        ###########################################
        RewriteCond %{ENV:REDIRECT_STATUS} ^$
        RewriteCond %{REQUEST_FILENAME} -f
        RewriteCond %{REQUEST_FILENAME} .*.php
        #RewriteCond %{REQUEST_FILENAME} !(update.php|index.php|install.php|xmlrpc.php|cron.php)
        RewriteCond %{REQUEST_FILENAME} !(index.php|cron.php)
        RewriteRule .* - [F,L]
        ########## END RULE 3 ###################

       # Rules to correctly serve gzip compressed CSS and JS files.
       # Requires both mod_rewrite and mod_headers to be enabled.
       <IfModule mod_headers.c>
           # Serve gzip compressed CSS files if they exist and the client accepts gzip.
           RewriteCond %{HTTP:Accept-encoding} gzip
           RewriteCond %{REQUEST_FILENAME}\.gz -s
           RewriteRule ^(.*)\.css $1\.css\.gz [QSA]

           # Serve gzip compressed JS files if they exist and the client accepts gzip.
           RewriteCond %{HTTP:Accept-encoding} gzip
           RewriteCond %{REQUEST_FILENAME}\.gz -s
           RewriteRule ^(.*)\.js $1\.js\.gz [QSA]
 
           # Serve correct content types, and prevent mod_deflate double gzip.
           RewriteRule \.css\.gz$ - [T=text/css,E=no-gzip:1]
           RewriteRule \.js\.gz$ - [T=text/javascript,E=no-gzip:1]

           <FilesMatch "(\.js\.gz|\.css\.gz)$">
               # Serve correct encoding type.
               Header set Content-Encoding gzip
               # Force proxies to cache gzipped & non-gzipped css/js files separately.
               Header append Vary Accept-Encoding
           </FilesMatch>
        </IfModule>

    </IfModule>


    <IfModule mod_php5.c>
      # Drupal defaults
      php_flag magic_quotes_gpc                 off
      php_flag magic_quotes_sybase              off
      php_flag register_globals                 off
      php_flag session.auto_start               off
      php_value mbstring.http_input             pass
      php_value mbstring.http_output            pass
      php_flag mbstring.encoding_translation    off

      # Our own settings

      # we do have uploads
      php_admin_flag  file_uploads            1
      php_admin_value upload_tmp_dir          "__TMP_PATH__"

      # Maximum allowed size for uploaded files.
      php_admin_value upload_max_filesize     "50M"
      php_admin_value max_input_time          120
      php_admin_value post_max_size           "50M"
      php_value max_execution_time            "300"
      php_value memory_limit                  "__MEMORY_LIMIT__"

      # Sessions: IMPORTANT reactivate garbage collector on Debian!!!
      php_value session.gc_maxlifetime        __SESSION_DURATION_SECONDS__
      php_admin_value session.gc_probability  1
      php_admin_value session.gc_divisor      100

      # logs
      php_admin_value display_errors          __DISPLAY_ERRORS__
      php_admin_value display_startup_errors  0
      php_admin_value html_errors             0
      php_admin_value log_errors              1
      php_admin_value define_syslog_variables 0
      #E_ALL & ~E_NOTICE -> 6135
      #E_ALL -> 6143
      #E_ALL^E_STRICT -> 8191
      # really all -> -1
      php_value error_reporting               6135

      php_admin_value open_basedir    ".:/var/www/__DOMAIN__/www:__TMP_PATH__:/var/www/__DOMAIN__/var/private:/usr/share/php/:/usr/share/php5/"
      php_value       include_path    ".:/var/www/__DOMAIN__/www:/var/www/__DOMAIN__/www/include"
      # you may need to allow url_fopen, but by default you should try without, sniff...
      php_admin_value allow_url_fopen 1
      # Do not show detailled headers with apache, apache modules, and php version
      php_admin_value expose_php      0
      # safe_mode is more buggy than no safe mode
      php_admin_value safe_mode       0

    </IfModule>

    </Directory>

</VirtualHost>
