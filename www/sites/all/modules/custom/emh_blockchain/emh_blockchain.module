<?php

/**
 * @file
 * EMH Blockchain.
 */

/**
 * Implements hook_libraries_info().
 */
function emh_blockchain_libraries_info() {
  $libraries['web3'] = array(
    'name' => 'web3.js',
    'vendor url' => 'https://github.com/ethereum/web3.js/',
    'download url' => 'https://github.com/ethereum/web3.js/releases',
    'version arguments' => array(
      'file' => 'dist/web3.min.js',
      'pattern' => '/version:"([0-9a-z\.-]+)"/',
      'lines' => 150,
    ),
    'files' => array(
      'js' => array('dist/web3.min.js'),
    ),
  );
  return $libraries;
}

/**
 * Implements hook_menu().
 */
function emh_blockchain_menu() {
  $items = array();

  $items['admin/emindhub/blockchain'] = array(
    'title' => 'Blockchain',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('emh_blockchain_admin_form'),
    'access arguments' => array('administer blockchain'),
    'file' => 'emh_blockchain.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  $items['blockchain/helloworld'] = array(
    'title' => 'Helloworld',
    'page callback' => '_emh_blockchain_helloworld',
    'access callback' => TRUE,
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function emh_blockchain_permission() {
  return array(
    'administer blockchain' => array('title' => t('Administer Blockchain')),
  );
}

/**
 * Blockchain helloworld.
 */
function _emh_blockchain_helloworld() {
  global $user;
  $content = '';

  if (($library = libraries_load('web3')) && !empty($library['loaded'])) {

    $header = array(
      t('Expert'),
      t('Votes'),
    );
    $rows = array(
      array('Captain America', array('data' => '', 'id' => 'candidate-1')),
      array('Charles Xavier', array('data' => '', 'id' => 'candidate-2')),
      array('Ironman', array('data' => '', 'id' => 'candidate-3')),
    );
    $content .= theme('table', array(
      'header' => $header,
      'rows' => $rows,
      'caption' => t('Those votes are read and written in the blockchain.'),
    ));
    $content .= '<input type="text" id="candidate" />
    <a href="#" id="submit" class="btn btn-primary">Vote</a>';
    $content .= '<br> user hash : '.$user->hash.'<div id="debug">toto</div>';

    drupal_add_js(array(
      'emh_blockchain' => array(
        'voting_deployed_contract_address' => variable_get('emh_blockchain_voting_deployed_contract_address'),
        'voting_deployed_contract_address_fallback' => variable_get('emh_blockchain_voting_deployed_contract_address_fallback'),
        'register_drupal_deployed_contract_address_fallback' => variable_get('emh_blockchain_RegisterDrupal_deployed_contract_address_fallback'),
        'register_drupal_deployed_contract_ABI' => variable_get('emh_blockchain_RegisterDrupal_deployed_contract_ABI'),
        'token_emh_deployed_contract_address_fallback' => variable_get('emh_blockchain_TokenEMH_deployed_contract_address_fallback'),
        'token_emh_deployed_contract_ABI' => variable_get('emh_blockchain_TokenEMH_deployed_contract_ABI'),
        'userHash' => $user->hash,
      ),
    ), 'setting');
    drupal_add_js(drupal_get_path('module', 'emh_blockchain') . '/contracts/helloworld/js/helloworld.js', array('scope' => 'footer'));
    drupal_add_js(drupal_get_path('module', 'emh_blockchain') . '/contracts/registerdrupal/js/registerdrupal.js', array('scope' => 'footer'));
  }
  else {
    $content = 'Web3 could not load.';
  }
  return $content;
}
