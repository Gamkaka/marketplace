<?php

/**
 * @file
 * Tracking features for EMH website.
 *
 * TODO: Different actions by $type, $referrer_id check...
 */

/**
 * Implements hook_menu().
 */
function emh_tracking_menu() {

  $items = array();

  // Route for inviting a new user.
  $items['link/%/%'] = array(
    'page callback' => '_emh_tracking_link',
    'page arguments' => array(1, 2),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Helper to create a cookie when an anonymous visitor visits the link.
 *
 * @string $type type of link action to perform.
 * @int referrer_id ID of the referrer (user, ...).
 */
function _emh_tracking_link($type, $referrer_id) {

  $params = drupal_get_query_parameters();

  // Only for valid internal URLs.
  if (isset($params['p']) && drupal_valid_path(drupal_lookup_path('source', $params['p']))) {
    $destination = $params['p'];
  }
  else {
    $destination = '';
  }

  // Only for anonymous users.
  if (user_is_anonymous()) {

    // If there is no link cookie:
    if (!isset($_COOKIE['Drupal_visitor_emh_tracking_link'])) {

      // Store our info in a string.
      $emh_tracking_link = serialize(
        array(
          't' => $type,
          'r' => $referrer_id,
          'd' => $destination,
        )
      );

      // Create and save the cookie.
      $cookie = array(
        'emh_tracking_link' => $emh_tracking_link,
      );
      user_cookie_save($cookie);
    }
  }

  // Redirect to destination.
  drupal_goto($destination);
}

/**
 * Implements hook_user_insert().
 */
function emh_tracking_user_insert(&$edit, $account, $category) {
  // TODO.
}
