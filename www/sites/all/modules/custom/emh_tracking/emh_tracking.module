<?php

/**
 * @file
 * Tracking features for EMH website.
 *
 * TODO: Different actions by $type, $referrer_id check...
 */

const EMH_TRACKING_COOKIE_DURATION = 60 * 60 * 24 * 365;

/**
 * Implements hook_boot().
 *
 * We have to, because URLs with query params are cached.
 */
function emh_tracking_boot() {

  if ($r = filter_input(INPUT_GET, 'r', FILTER_SANITIZE_STRING)) {

    // If it's alphanumeric and if there is no EMH cookie:
    if (ctype_alnum($r) && !isset($_COOKIE['emh'])) {

      // Normally don't have to sanitize but we never know.
      $http_referer = $_SERVER['HTTP_REFERER'] ? filter_input(INPUT_SERVER, 'HTTP_REFERER', FILTER_SANITIZE_STRING) : '';

      // Store our tracking info.
      $tracking_info = json_encode(
        array(
          'r' => $r,
          'h' => $http_referer,
        )
      );

      // Create and save the cookie.
      setcookie('emh', $tracking_info, time() + EMH_TRACKING_COOKIE_DURATION, '/');
    }
  }
}

/**
 * Implements hook_user_presave().
 */
function emh_tracking_user_presave(&$edit, $account, $category) {

  // If there is a tracking cookie:
  if (isset($_COOKIE['emh'])) {

    // Sanitize the content of the cookie first.
    $tracking_info = filter_input(INPUT_COOKIE, 'emh', FILTER_SANITIZE_STRING);

    // Then add the tracking info in the user profile.
    $edit['field_tracking'][LANGUAGE_NONE][0]['value'] = $tracking_info;
  }
}
