<?php

/**
 * @file
 * Tracking features for EMH website.
 */

const EMH_TRACKING_COOKIE_DURATION = 60 * 60 * 24 * 365;

/**
 * Implements hook_boot().
 *
 * We have to, because URLs with query params are cached.
 */
function emh_tracking_boot() {

  if ($r = filter_input(INPUT_GET, 'r', FILTER_SANITIZE_STRING)) {

    // If it's alphanumeric and if there is no EMH cookie:
    if (ctype_alnum($r) && !isset($_COOKIE['emh'])) {

      // Normally don't have to sanitize.
      $http_referer = $_SERVER['HTTP_REFERER'] ? $_SERVER['HTTP_REFERER'] : '';

      // Store our tracking info.
      $tracking_info = json_encode(
        array(
          'r' => $r,
          'h' => $http_referer,
        )
      );

      // Create and save the cookie.
      setcookie('emh', $tracking_info, time() + EMH_TRACKING_COOKIE_DURATION, '/');
    }
  }
}

/**
 * Implements hook_user_presave().
 */
function emh_tracking_user_presave(&$edit, $account, $category) {

  if ($account->is_new) {

    // If there is a tracking cookie:
    if (isset($_COOKIE['emh'])) {

      $tracking_info = json_decode($_COOKIE['emh'], TRUE);

      // Validate and record the tracking key.
      if (isset($tracking_info['r']) && ctype_alnum($tracking_info['r'])) {
        $edit['field_tracking_key'][LANGUAGE_NONE][0]['value'] = $tracking_info['r'];
      }
      // Record the referer URL.
      $http_referer = check_url(stripslashes($tracking_info['h']));
      if (isset($tracking_info['h']) && valid_url($http_referer, TRUE)) {
        $edit['field_tracking_referer'][LANGUAGE_NONE][0]['url'] = $http_referer;
      }
    }
  }
}
